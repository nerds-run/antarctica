---
- name: Verify base role
  hosts: all
  become: true
  tasks:
    - name: Gather service facts
      ansible.builtin.service_facts:

    - name: Assert sshd is running
      ansible.builtin.assert:
        that:
          - "'sshd.service' in ansible_facts.services or 'ssh.service' in ansible_facts.services"
        fail_msg: "SSH service is not running"

    - name: Check sshd config denies password auth
      ansible.builtin.command: sshd -T
      register: base_sshd_config
      changed_when: false
      failed_when: false

    - name: Check unattended-upgrades is installed
      ansible.builtin.package:
        name: unattended-upgrades
        state: present
      check_mode: true
      register: base_unattended
      failed_when: base_unattended is changed

    - name: Check nftables is installed
      ansible.builtin.package:
        name: nftables
        state: present
      check_mode: true
      register: base_nftables_pkg
      failed_when: base_nftables_pkg is changed

    - name: Verify data directories exist
      ansible.builtin.stat:
        path: "{{ item }}"
      register: base_data_dirs_check
      loop:
        - /data
        - /data/forgejo
        - /data/woodpecker
        - /data/postgresql
        - /data/caddy

    - name: Assert data directories exist
      ansible.builtin.assert:
        that:
          - item.stat.exists
          - item.stat.isdir
        fail_msg: "Directory {{ item.item }} does not exist"
      loop: "{{ base_data_dirs_check.results }}"

    - name: Check timezone is set
      ansible.builtin.command: timedatectl show --property=Timezone --value
      register: base_tz_result
      changed_when: false
      failed_when: false

    - name: Check qemu-guest-agent is installed
      ansible.builtin.package:
        name: qemu-guest-agent
        state: present
      check_mode: true
      register: base_qga_pkg
      failed_when: base_qga_pkg is changed
