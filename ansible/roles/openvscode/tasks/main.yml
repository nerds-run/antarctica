---
- name: Create OpenVSCode Server data directory
  ansible.builtin.file:
    path: "{{ openvscode_data_dir }}"
    state: directory
    mode: "0755"

# -- Quadlet container file --
- name: Deploy OpenVSCode Server quadlet container file
  ansible.builtin.template:
    src: openvscode-server.container.j2
    dest: /etc/containers/systemd/openvscode-server.container
    mode: "0644"
  register: openvscode_quadlet

# -- Reload and start --
- name: Reload systemd daemon for quadlet
  ansible.builtin.systemd:
    daemon_reload: true
  tags:
    - molecule-notest

- name: Enable and start OpenVSCode Server container
  ansible.builtin.systemd:
    name: openvscode-server
    enabled: true
    state: started
  tags:
    - molecule-notest

- name: Restart OpenVSCode Server on config change # noqa: no-handler
  ansible.builtin.systemd:
    name: openvscode-server
    state: restarted
  when: openvscode_quadlet is changed
  tags:
    - molecule-notest
