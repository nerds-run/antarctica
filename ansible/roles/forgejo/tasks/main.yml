---
- name: Create Forgejo data directory
  ansible.builtin.file:
    path: "{{ forgejo_data_dir }}"
    state: directory
    mode: "0755"

- name: Create Forgejo config directory
  ansible.builtin.file:
    path: "{{ forgejo_config_dir }}"
    state: directory
    mode: "0750"

- name: Create Forgejo PostgreSQL data directory
  ansible.builtin.file:
    path: "{{ forgejo_db_data_dir }}"
    state: directory
    mode: "0700"

- name: Create Actions Runner data directory
  ansible.builtin.file:
    path: "{{ forgejo_data_dir }}/actions-runner"
    state: directory
    mode: "0755"

# -- Fetch secrets from 1Password --
- name: Retrieve Forgejo database password from 1Password
  ansible.builtin.command:
    cmd: "op read '{{ forgejo_op_db_password }}'"
  register: forgejo_db_password_result
  changed_when: false
  no_log: true
  delegate_to: localhost
  become: false
  tags:
    - molecule-notest

- name: Set Forgejo database password fact
  ansible.builtin.set_fact:
    forgejo_db_password: "{{ forgejo_db_password_result.stdout }}"
  no_log: true
  tags:
    - molecule-notest

- name: Retrieve Forgejo secret key from 1Password
  ansible.builtin.command:
    cmd: "op read '{{ forgejo_op_secret_key }}'"
  register: forgejo_secret_key_result
  changed_when: false
  no_log: true
  delegate_to: localhost
  become: false
  tags:
    - molecule-notest

- name: Retrieve Forgejo internal token from 1Password
  ansible.builtin.command:
    cmd: "op read '{{ forgejo_op_internal_token }}'"
  register: forgejo_internal_token_result
  changed_when: false
  no_log: true
  delegate_to: localhost
  become: false
  tags:
    - molecule-notest

- name: Retrieve Forgejo OAuth2 JWT secret from 1Password
  ansible.builtin.command:
    cmd: "op read '{{ forgejo_op_oauth2_jwt_secret }}'"
  register: forgejo_oauth2_jwt_result
  changed_when: false
  no_log: true
  delegate_to: localhost
  become: false
  tags:
    - molecule-notest

- name: Retrieve Forgejo LFS JWT secret from 1Password
  ansible.builtin.command:
    cmd: "op read '{{ forgejo_op_lfs_jwt_secret }}'"
  register: forgejo_lfs_jwt_result
  changed_when: false
  no_log: true
  delegate_to: localhost
  become: false
  tags:
    - molecule-notest

- name: Set Forgejo secret facts
  ansible.builtin.set_fact:
    forgejo_secret_key: "{{ forgejo_secret_key_result.stdout }}"
    forgejo_internal_token: "{{ forgejo_internal_token_result.stdout }}"
    forgejo_oauth2_jwt_secret: "{{ forgejo_oauth2_jwt_result.stdout }}"
    forgejo_lfs_jwt_secret: "{{ forgejo_lfs_jwt_result.stdout }}"
  no_log: true
  tags:
    - molecule-notest

# -- Forgejo PostgreSQL Quadlet --
- name: Deploy Forgejo PostgreSQL quadlet container file
  ansible.builtin.template:
    src: forgejo-postgresql.container.j2
    dest: /etc/containers/systemd/forgejo-postgresql.container
    mode: "0644"
  no_log: true
  register: forgejo_db_quadlet

# -- Env file --
- name: Deploy Forgejo env file
  ansible.builtin.template:
    src: forgejo.env.j2
    dest: "{{ forgejo_config_dir }}/forgejo.env"
    mode: "0600"
  no_log: true
  register: forgejo_env

# -- Quadlet container file --
- name: Deploy Forgejo quadlet container file
  ansible.builtin.template:
    src: forgejo.container.j2
    dest: /etc/containers/systemd/forgejo.container
    mode: "0644"
  register: forgejo_quadlet

# -- Gitea Actions Runner --
- name: Retrieve Actions Runner token from 1Password
  ansible.builtin.command:
    cmd: "op read '{{ forgejo_op_action_runner_token }}'"
  register: forgejo_action_runner_token_result
  changed_when: false
  no_log: true
  delegate_to: localhost
  become: false
  tags:
    - molecule-notest

- name: Set Actions Runner token fact
  ansible.builtin.set_fact:
    forgejo_action_runner_token: "{{ forgejo_action_runner_token_result.stdout }}"
  no_log: true
  tags:
    - molecule-notest

- name: Deploy Actions Runner env file
  ansible.builtin.copy:
    content: "GITEA_RUNNER_REGISTRATION_TOKEN={{ forgejo_action_runner_token }}\n"
    dest: "{{ forgejo_actions_runner_config_dir }}/action-runner.env"
    mode: "0600"
  no_log: true
  register: forgejo_actions_runner_env

- name: Deploy Gitea Actions Runner quadlet container file
  ansible.builtin.template:
    src: actions-runner.container.j2
    dest: /etc/containers/systemd/actions-runner.container
    mode: "0644"
  register: forgejo_actions_runner_quadlet

# -- Reload and start --
- name: Reload systemd daemon for quadlet
  ansible.builtin.systemd:
    daemon_reload: true
  tags:
    - molecule-notest

- name: Enable and start Forgejo PostgreSQL container
  ansible.builtin.systemd:
    name: forgejo-postgresql
    enabled: true
    state: started
  tags:
    - molecule-notest

- name: Enable and start Forgejo container
  ansible.builtin.systemd:
    name: forgejo
    enabled: true
    state: started
  tags:
    - molecule-notest

- name: Enable and start Actions Runner container
  ansible.builtin.systemd:
    name: actions-runner
    enabled: true
    state: started
  tags:
    - molecule-notest

- name: Restart Forgejo PostgreSQL on config change # noqa: no-handler
  ansible.builtin.systemd:
    name: forgejo-postgresql
    state: restarted
  when: forgejo_db_quadlet is changed
  tags:
    - molecule-notest

- name: Restart Forgejo on config change # noqa: no-handler
  ansible.builtin.systemd:
    name: forgejo
    state: restarted
  when: forgejo_env is changed or forgejo_quadlet is changed
  tags:
    - molecule-notest

- name: Restart Actions Runner on config change # noqa: no-handler
  ansible.builtin.systemd:
    name: actions-runner
    state: restarted
  when: forgejo_actions_runner_env is changed or forgejo_actions_runner_quadlet is changed
  tags:
    - molecule-notest

# -- OAuth2 application provisioning --
- name: Wait for Forgejo API to be ready
  ansible.builtin.uri:
    url: "http://127.0.0.1:{{ forgejo_http_port }}/api/v1/settings/api"
    method: GET
    status_code: 200
  register: forgejo_api_health
  until: forgejo_api_health.status == 200
  retries: 15
  delay: 2
  tags:
    - molecule-notest

- name: Generate Forgejo API token for provisioning # noqa: no-changed-when
  ansible.builtin.shell:
    cmd: >-
      podman exec --user git {{ forgejo_container_name }}
      forgejo admin user generate-access-token
      --username {{ forgejo_admin_user }}
      --token-name "ansible-$(date +%s)"
      --scopes all
  register: forgejo_token_result
  tags:
    - molecule-notest

- name: Set API token fact
  ansible.builtin.set_fact:
    forgejo_api_token: "{{ forgejo_token_result.stdout | regex_search('Access token was successfully created: (.+)', '\\1') | first }}"
  no_log: true
  tags:
    - molecule-notest

- name: List existing OAuth2 applications
  ansible.builtin.uri:
    url: "http://127.0.0.1:{{ forgejo_http_port }}/api/v1/user/applications/oauth2"
    method: GET
    headers:
      Authorization: "token {{ forgejo_api_token }}"
    status_code: 200
  register: forgejo_existing_oauth2_apps
  no_log: true
  tags:
    - molecule-notest

- name: Create OAuth2 applications
  ansible.builtin.uri:
    url: "http://127.0.0.1:{{ forgejo_http_port }}/api/v1/user/applications/oauth2"
    method: POST
    headers:
      Authorization: "token {{ forgejo_api_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      name: "{{ item.name }}"
      redirect_uris: "{{ item.redirect_uris }}"
      confidential_client: true
    status_code: 201
  register: forgejo_oauth2_created
  loop: "{{ forgejo_oauth2_apps }}"
  when: item.name not in (forgejo_existing_oauth2_apps.json | map(attribute='name') | list)
  no_log: true
  tags:
    - molecule-notest

- name: Display OAuth2 credentials to store in 1Password
  ansible.builtin.debug:
    msg: >-
      Store in 1Password vault '{{ item.item.op_vault }}' item '{{ item.item.op_item }}':
      {{ item.item.op_client_field }}={{ item.json.client_id }}
      {{ item.item.op_secret_field }}={{ item.json.client_secret }}
  loop: "{{ forgejo_oauth2_created.results }}"
  when: item is not skipped
  tags:
    - molecule-notest

- name: Clean up ansible provisioning tokens # noqa: no-changed-when
  ansible.builtin.command:
    cmd: >-
      podman exec {{ forgejo_db_container_name }}
      psql -U {{ forgejo_db_user }} -d {{ forgejo_db_name }}
      -c "DELETE FROM access_token WHERE name LIKE 'ansible-%'"
  failed_when: false
  tags:
    - molecule-notest
