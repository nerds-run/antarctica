---
# -- Add alvistack OBS repo for podman 5.x (Quadlet support) --
- name: Install prerequisites for podman repo
  ansible.builtin.apt:
    name:
      - curl
      - gnupg
    state: present

- name: Ensure keyrings directory exists
  ansible.builtin.file:
    path: /etc/apt/keyrings
    state: directory
    mode: "0755"

- name: Download alvistack GPG key
  ansible.builtin.get_url:
    url: https://download.opensuse.org/repositories/home:/alvistack/Debian_12/Release.key
    dest: /etc/apt/keyrings/alvistack.asc
    mode: "0644"

- name: Dearmor alvistack GPG key # noqa: command-instead-of-module
  ansible.builtin.command:
    cmd: gpg --dearmor -o /etc/apt/keyrings/alvistack.gpg /etc/apt/keyrings/alvistack.asc
    creates: /etc/apt/keyrings/alvistack.gpg

- name: Add alvistack apt repository
  ansible.builtin.apt_repository:
    repo: >-
      deb [signed-by=/etc/apt/keyrings/alvistack.gpg]
      http://download.opensuse.org/repositories/home:/alvistack/Debian_12/ /
    filename: alvistack
    state: present
    update_cache: true

- name: Pin alvistack repo to low priority (only use for container packages)
  ansible.builtin.copy:
    content: |
      Package: *
      Pin: origin download.opensuse.org
      Pin-Priority: 100

      Package: podman buildah crun containers-common conmon fuse-overlayfs slirp4netns
      Pin: origin download.opensuse.org
      Pin-Priority: 900
    dest: /etc/apt/preferences.d/alvistack
    mode: "0644"

- name: Remove deprecated kubic repo if present
  ansible.builtin.apt_repository:
    repo: >-
      deb [signed-by=/etc/apt/keyrings/kubic-libcontainers.gpg]
      https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/unstable/Debian_12/ /
    filename: kubic-libcontainers
    state: absent

- name: Remove conflicting Debian containers-common package
  ansible.builtin.apt:
    name: golang-github-containers-common
    state: absent
  failed_when: false

- name: Install podman and buildah
  ansible.builtin.apt:
    name:
      - podman
      - buildah
      - slirp4netns
      - crun
      - fuse-overlayfs
      - netavark
      - aardvark-dns
      - cron
    state: present
    dpkg_options: force-overwrite,force-confold
  environment:
    DEBIAN_FRONTEND: noninteractive

# -- Registries config --
- name: Deploy registries.conf
  ansible.builtin.template:
    src: registries.conf.j2
    dest: /etc/containers/registries.conf
    mode: "0644"

# -- Storage config --
- name: Deploy storage.conf
  ansible.builtin.template:
    src: storage.conf.j2
    dest: /etc/containers/storage.conf
    mode: "0644"

# -- Container data directories --
- name: Create container data directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  loop: "{{ container_runtime_data_dirs }}"

# -- Quadlet directory --
- name: Ensure systemd quadlet directory exists
  ansible.builtin.file:
    path: /etc/containers/systemd
    state: directory
    mode: "0755"

# -- Container network --
- name: Check if podman network exists
  ansible.builtin.command:
    cmd: "podman network inspect {{ container_runtime_network_name }}"
  register: container_runtime_network_check
  changed_when: false
  failed_when: false
  tags:
    - molecule-notest

- name: Create podman network
  ansible.builtin.command:
    cmd: "podman network create {{ container_runtime_network_name }}"
  when: container_runtime_network_check.rc != 0
  changed_when: true
  tags:
    - molecule-notest

# -- Podman socket for API access --
- name: Enable podman socket
  ansible.builtin.systemd:
    name: podman.socket
    enabled: true
    state: started
  tags:
    - molecule-notest

# -- Podman auto-update timer --
- name: Enable podman auto-update timer
  ansible.builtin.systemd:
    name: podman-auto-update.timer
    enabled: true
    state: started
  tags:
    - molecule-notest

# -- Container prune cron --
- name: Set up container prune cron job
  ansible.builtin.cron:
    name: "Podman container prune"
    minute: "0"
    hour: "3"
    weekday: "0"
    job: "podman system prune -f --volumes 2>&1 | logger -t podman-prune"
    user: root
